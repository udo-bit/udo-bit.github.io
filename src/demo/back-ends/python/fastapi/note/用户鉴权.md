---
title: 用户鉴权
icon: code
order: 1
---

```python
from datetime import datetime, timedelta
from fastapi import FastAPI, Depends, HTTPException
from passlib.context import CryptContext
from typing import Annotated
import jwt
from fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm
from pydantic import BaseModel

# secret key
SECRET_KEY = "bd5f13d1cf899a9c701f62592c207642e81eac9a3b172359c2feef55932b6385"
# 定义加密算法
ALGORITHM = "HS256"
# 定义过期时间
ACCESS_TOKEN_EXPIRE_MINUTES = 30
pwb_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")

app = FastAPI()

fake_users_db = {
    "johndoe": {
        "username": "johndoe",
        "full_name": "John Doe",
        "email": "johndoe@example.com",
        "hashed_password": "$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW",
        "disabled": False,
    }
}


class User(BaseModel):
    username: str
    email: str
    full_name: str
    disabled: bool = None

# token模型
class Token(BaseModel):
    access_token: str
    token_type: str


# 哈希加密
def get_password_hash(password):
    return pwb_context.hash(password)


# 验证密码
def verify_password(plain_password, hashed_password):
    return pwb_context.verify(plain_password, hashed_password)

# 签发token
def create_access_token(data: dict, expires_delta: int):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=expires_delta)
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt

# 获取当前用户
def get_current_user(token: str = Depends(oauth2_scheme)):
    credentials_exception = HTTPException(
        status_code=401,
        detail="Could not validate credentials",
        headers={"WWW-Authenticate": "Bearer"},
    )
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username: str = payload.get("sub")
        if username is None:
            raise credentials_exception
    except jwt.PyJWTError:
        raise credentials_exception
    user = fake_users_db.get(username)
    if user is None:
        raise credentials_exception
    return user

# token url
@app.post('/token', description='获取token')
def login_for_access_token(form_data: Annotated[OAuth2PasswordRequestForm, Depends()]):
    user = fake_users_db.get(form_data.username)
    if not user:
        raise HTTPException(status_code=400, detail="Incorrect username or password")
    if not verify_password(form_data.password, user['hashed_password']):
        raise HTTPException(status_code=400, detail="Incorrect username or password")
    access_token_expires = ACCESS_TOKEN_EXPIRE_MINUTES
    access_token = create_access_token(data={"sub": user["username"]}, expires_delta=access_token_expires)

    return {"access_token": access_token, "token_type": "bearer"}

# 需要鉴权的业务
@app.get('/items/', dependencies=[Depends(get_current_user)])
def get_item():
    return "hello,world" 
```

